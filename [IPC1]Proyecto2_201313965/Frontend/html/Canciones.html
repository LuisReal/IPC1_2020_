<html>

<head>
    <script>
        window.addEventListener('pageshow', function(event) {
            if (!localStorage.getItem('usuario')) {
                // Si no hay sesi√≥n, redirige inmediatamente
                location.replace("../index.html");
            } 
            MostrarCanciones(); 
            mostrarPerfil();
        });
    </script>
    <link href="../css/Canciones.css" rel="stylesheet">
    <link href="../css/navbar.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

    <div class="global-container">

        <button id="btn-open-menu" class="btn-open-navbar"><i class="bi bi-list"></i></button>

        <div class="banner-izquierdo" id="banner-izquierdo">

            <button id="btn-close-menu" class="btn-close-navbar"><i class="bi bi-x-square"></i></button>
            <label class="foto-perfil"></label>
            

            <div class="botones-container">

                <h1 id="usuario" class="nombre-usuario"></h1>
                
                <button onclick="back()" type="button" class="btn-pagina-principal">Pagina Principal</button>
                <button onclick="miPerfil()" type="button" class="btn-mi-perfil">Mi Perfil</button>
                <button onclick="back()" type="button" class="boton-back">Back</button>
            </div>

            <button href="javascript:cerrar()" onclick="cerrarSesion()" type="button" class="boton-cerrarSesion">Cerrar
                Sesion</button>

        </div>

        <div class="info-container">

            <h2>Canciones Registradas</h2>
            <button type="button" onclick="CargarArchivo()" class="boton-cargar">Cargar Canciones</button>
            <input type="file" id="file" class="input-file">

            <table>
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Nombre</th>
                        <th>Artista</th>
                        <th>Album</th>
                        <th>Fecha</th>
                        <th>Imagen</th>
                        <th>Play</th>
                    </tr>
                </thead>

                <tbody id="body">
                </tbody>
            </table>

        </div>
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        function cerrarSesion() {
            sessionStorage.removeItem('usuario');
            location.href = "../index.html"
        }
        
        function back() {
            location.href = "administrador.html"
        }

        function miPerfil() {
            location.href = "ModificarPerfilAdministrador.html"
        }
        function mostrarPerfil() {

            fetch('http://3.150.236.120:8000/Admin',  //3.129.19.112

            ).then(response => response.json()
            ).catch(err => {
                console.log("no se pudo consumir la api")
            }).then(res => {
                console.log(res)


                var valor = res.admin // Proviene de ModificarPerfilAdministrador.html (Modificar()) 

                var h1 = document.querySelector('#usuario')
                h1.innerHTML +=
                    `
                        <h1>${valor}</h1>
                        
                        `
            })

        }
        function CargarArchivo() {

            $('#file').parse({         //recive un archivo csv
                config: {
                    delimiter: ";",
                    complete: guardarCanciones,
                },
                before: function (file, inputElem) {
                    console.log("Parsing file...", file);
                },
                error: function (err, file) {
                    console.log("ERROR:", err, file);
                },
                complete: function () {
                    console.log("Done with all files");
                }
            });
        }

        async function guardarCanciones(results) {
            console.log(results.data)
            var data = results.data;   //un array de strings de los datos del archivo csv.
            var val = true;

            for (i = 0; i < data.length - 1; i++) {
                var nombre = data[i][0]    //primero fila y despues columna
                var artista = data[i][1]
                var album = data[i][2]
                var fecha = data[i][3]
                var imagen = data[i][4]
                var spotify = data[i][5]
                var youtube = data[i][6]
                var audio = data[i][7]

                console.log('El audio es :', audio)
                

                var objeto = {
                    'nombre': nombre,
                    'artista': artista,
                    'album': album,
                    'fecha': fecha,
                    'imagen': imagen,
                    'spotify': spotify,
                    'youtube': youtube,
                    'audio' : audio
                }


                fetch('http://3.150.236.120:8000/Canciones', {
                    method: 'POST',
                    body: JSON.stringify(objeto),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json()

                ).catch(error => {
                    console.error('Error:', error)

                    val = false
                }).then(res => {
                    console.log('Success:', res)
                })


            }

            if (val = true) {

                alert("Se agregaron las canciones exitosamente")
                MostrarCanciones()
            }

        }

        function MostrarCanciones() {

            var contenido = document.querySelector('#body')
            contenido.innerHTML = ""
            fetch('http://3.150.236.120:8000/Canciones'
            ).then(response => response.json()
            ).catch(error => {
                console.log(error)

            }).then(res => {
                for (var i in res) {
                    contenido.innerHTML += `
                            <tr>
                                <td>${res[i].id}</td>
                                <td>${res[i].nombre}</td>
                                <td>${res[i].artista}</td>
                                <td>${res[i].album}</td>
                                <td>${res[i].fecha}</td>
                                <td><img src="${res[i].imagen}" height="200" width="200"></td>
                                <td><iframe src="${res[i].spotify}" width="300" height="330" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe></td>
                            </tr>
                            `
                }
            })

        }

    </script>
    <script>
        const open_menu = document.getElementById("btn-open-menu");
        const close_menu = document.getElementById("btn-close-menu");
        const navbar = document.getElementById("banner-izquierdo");


        open_menu.addEventListener("click", () => {
            console.log("hiciste click en abrir menu");
            navbar.classList.add("visible");
        });

        close_menu.addEventListener("click", () => {
            console.log("hiciste click en cerrar menu");
            navbar.classList.remove("visible");
        });

    </script>
</body>

</html>